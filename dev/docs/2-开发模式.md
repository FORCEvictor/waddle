[返回开发者计划主文档](https://gitee.com/coco-ag/coco-waddle/tree/master/dev/README.md)

# Waddle 开发模式

## 定义块

块定义描述了块的外观和行为，包括文本，颜色，形状以及它可以连接的其他块。

如果你想看英文版原文，请点[这里](https://developers.google.cn/blockly/guides/create-custom-blocks/define-blocks)。

`init`函数创建块的形状。在此功能的上下文中，关键字`this`是正在创建的实际块。

示例 1：

```javascript
Blockly.Blocks['string_length'] = {
    init: function () {
        this.appendValueInput('VALUE').setCheck('String').appendField('length of');
        this.setOutput(true, 'Number');
        this.setColour(160);
        this.setTooltip('Returns number of letters in the provided text.');
        this.setHelpUrl('http://www.w3schools.com/jsref/jsref_length_string.asp');
    }
};
```

---

### 块输入

一个块有一个或多个输入，其中每个输入都是一系列可能以连接结尾的标签和字段。有三种类型的输入，与连接类型匹配：

- 值输入`ValueInput`：用以填充值块的凹槽。
- 语句输入`StatementInput`：连接到语句块的顶端连接口。
- 虚拟输入`DummyInput`：没有块连接。但可以执行字段的操作。

![input](https://developers.google.cn/blockly/images/input-types.png)

关于值输入与虚拟输入，可以参见上图中 internal value input 与"while"。

---

可以使用`append`方法进行输入：

示例 2：

```javascript
this.appendDummyInput().appendField('for each').appendField('item').appendField(new Blockly.FieldVariable());
this.appendValueInput('LIST').setCheck('Array').setAlign(Blockly.ALIGN_RIGHT).appendField('in list');
this.appendStatementInput('DO').appendField('do');
```

![示例2](https://developers.google.cn/blockly/images/append-input.png)

每个方法都可以采用代码生成器使用的标识符字符串。虚拟输入很少需要引用，并且通常不设置标识符。

如上所示，每个方法都返回输入对象，用来通过方法链接对其进行配置。

有 3 个函数用于配置输入：`appendField()`、`setCheck()` 和 `setAlign()`。

- `appendField`：一旦创建了输入并将其附加到带有 `append_____Input`的块中，就可以选择将任意数量的字段叠加到输入中。 这些字段通常用作标签来描述每个输入的用途。

    ```javascript
    input.appendField('hello');
    ```

    ![hello](https://developers.google.cn/blockly/images/append-field.png)

    ```javascript
    input.appendField('hello')
        .appendField(new Blockly.FieldLabel('Neil', 'person'));
    ```

    ![hello nell](https://developers.google.cn/blockly/images/append-field-label.png)

    blockly 内置了 12 种字段：

  - [数字](https://developers.google.cn/blockly/guides/create-custom-blocks/fields/built-in-fields/number)
  - [文本输入](https://developers.google.cn/blockly/guides/create-custom-blocks/fields/built-in-fields/text-input)
  - [多行文本输入](https://developers.google.cn/blockly/guides/create-custom-blocks/fields/built-in-fields/multiline-text-input)
  - [变量](https://developers.google.cn/blockly/guides/create-custom-blocks/fields/built-in-fields/variable)
  - [图像](https://developers.google.cn/blockly/guides/create-custom-blocks/fields/built-in-fields/image)
  - [标签](https://developers.google.cn/blockly/guides/create-custom-blocks/fields/built-in-fields/label)
  - [可序列化标签](https://developers.google.cn/blockly/guides/create-custom-blocks/fields/built-in-fields/label-serializable)
  - [复选框](https://developers.google.cn/blockly/guides/create-custom-blocks/fields/built-in-fields/checkbox)
  - [下拉菜单](https://developers.google.cn/blockly/guides/create-custom-blocks/fields/built-in-fields/dropdown)
  - [角度选择器](https://developers.google.cn/blockly/guides/create-custom-blocks/fields/built-in-fields/angle)
  - [颜色选择器](https://developers.google.cn/blockly/guides/create-custom-blocks/fields/built-in-fields/colour)
  - [日期选择器](https://developers.google.cn/blockly/guides/create-custom-blocks/fields/built-in-fields/date)

- `setCheck`：此可选函数用于检查连接输入的类型。（设置 null 时不检查）。

- `setAlign`：此可选函数用于对齐字段。可以将三个自描述值作为该函数的参数传递：`Blockly.ALIGN_LEFT`，`Blockly.ALIGN_RIGHT` 和 `Blockly.ALIGN_CENTRE`。默认为左对齐。

---

配置输入结束后，你可以设置其他功能。

如果你的块输入是外接样式，请使用以下函数来实现内联样式：

```javascript
init: function() {
  // ...
  this.setInputsInline(true);
}
```

![inline](https://developers.google.cn/blockly/images/set-inputs-inline.png)

当用户将鼠标悬停在块上时，工具提示可以提供即时帮助。如果文本很长，它将自动换行。

```javascript
init: function() {
  this.setTooltip("Tooltip text.");
}
```

当然，当你的一个块需要实现多种功能时（例如下拉菜单选择+-\*/^），工具提示也能动态加载。

```javascript
Blockly.Blocks['math_arithmetic'] = {
    init: function () {
        // 将“this”分配给一个变量，以便在下面的工具提示闭包中使用。
        var thisBlock = this;
        this.setTooltip(function () {
            var mode = thisBlock.getFieldValue('OP');
            var TOOLTIPS = {
                ADD: Blockly.Msg.MATH_ARITHMETIC_TOOLTIP_ADD,
                MINUS: Blockly.Msg.MATH_ARITHMETIC_TOOLTIP_MINUS,
                MULTIPLY: Blockly.Msg.MATH_ARITHMETIC_TOOLTIP_MULTIPLY,
                DIVIDE: Blockly.Msg.MATH_ARITHMETIC_TOOLTIP_DIVIDE,
                POWER: Blockly.Msg.MATH_ARITHMETIC_TOOLTIP_POWER
            };
            return TOOLTIPS[mode];
        });
    }
};
```

---

块可以有一个与之关联的帮助页面。用户可以通过右键菜单中选择“帮助”来使用此功能。如果此值为`null`，则菜单显示为灰色。

```javascript
init: function() {
  // ...
  this.setHelpUrl('https://en.wikipedia.org/wiki/For_loop');
}
```

---

块可以具有侦听器函数，它在对工作区的任何更改（包括与块无关的更改）时调用。它们主要用于设置块的警告文本，或在工作区外部设置类似的用户通知。

```javascript
Blockly.Blocks['block_type'] = {
    init: function () {
        // Example validation upon block change:
        this.setOnChange(function (changeEvent) {
            if (this.getInput('NUM').connection.targetBlock()) {
                this.setWarningText(null);
            } else {
                this.setWarningText('Must have an input block.');
            }
        });
    }
};
```

为保障效率，请不要为此编写大量低效代码。

---

如果你的块需要根据需求增加或缩减部分结构（例如if……elseif……else），可以使用突变体。

![if……elseif……else](https://developers.google.cn/blockly/images/if-mutated.png)

参考blockly[拓展和突变体](https://developers.google.cn/blockly/guides/create-custom-blocks/extensions)。

---

块还可以采用一些特殊方法进行限制，比如：

- 禁止删除：`this.setDeletable(false);`
  
  但是任意块可以通过程序强制删除：`block.dispose();`

- 禁止编辑：`this.setEditable(false);`

- 禁止移动：`this.setMovable(false);`

  但是任意块可以通过程序强制移动：`block.moveBy(dx, dy);`

- 禁止右键菜单：`block.contextMenu = false;`

  你仍可以细化该操作，请参阅[上下文菜单API](https://developers.google.cn/blockly/guides/configure/web/context-menus)。

- 粘合数据：`this.data = '16dcb3a4-bd39-11e4-8dfc-aa07a5b093db';`

---

2022.4.23