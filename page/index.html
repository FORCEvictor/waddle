<html lang="zh">
<!--
    BUG1:高亮未处理
    TODO1:新建窗口
    TODO2:自定义控件及附属功能
    TODO3:代码窗
-->


<head>
    <script>
        /*var a = `
                                                                                       
                    ::::::::::::::               :               ffffffffffffff              
                    :::::::::;;;;;              ::              ffffffffffffff               
                    ,;;;;;;;;;;;;;             ::::            ffffffffffffff                
                    ;;;;;;;;;;;;;;           :::::           .ttttttttfffff,                 
                        ;;;;;;;;;;;;;:         ::::::;          tttttttttttttt               
                        ;;;;;;;;;;;;;;         ::::;;;;        1ttttttttttttt                
                        ;;;;;;;;;;;;;;       ::::;;;;;i       tttttttttttttt                 
                        ;;;;;;;;;;;;;;      ::::;;;;;ii      tttttttttttttt                  
                        ;;;;;;;;;;;;;;    ::::;;;;;iiii     11111111tttttt                   
                        :;;;;;;;;;;;;;    ::;;;;;;iiiii1   11111111111111                    
                        ;;;;;;;;iiiiii  ::;;;;;;iiiii111  1111111111111:                     
                            iiiiiiiiiiiii ::;;;;;iiiiii1111,11111111111111                
                            iiiiiiiiiiiii::;;;;;iiiii111111t1111111111111                    
                            iiiiiiiiiiii:;;;;;iiiii111111tiiiiiiii111111                     
                            iiiiiiiiiii;;;;;;iiiii11111tttiiiiiiiiiiiii                      
                            iiiiiiiii;;;;;iiiiii11111tttiiiiiiiiiiiiii                       
                            iiiiiiii;;;;;iiiiii11111ttttiiiiiiiiiiiii                        
                            iiiiiii;;;;iiiii111111ttttiiiiiiiiiiiii;                         
                                iiiii;;;;iiiii1111 ttttti;;;;;;iiiiiii                       
                                iiii;;;;iiiii1111   tttt;;;;;;;;;;;;;                        
                                ii;;;iiiiii11111    tt;;;;;;;;;;;;;;                        
                                ii;;iiiii111111      t;;;;;;;;;;;;;                          
        `
        console.log(a)*/
        //暂时按照小王的意，移除了W
        console.log("嘿，欢迎使用 Waddle!\n本工具基于Blockly开发，由 中子星000（QQ：2422481178）主理制作、MathCalculus（QQ：2504556268）与小鱼yuzifu（QQ：1906929246），刘lyxAndy（QQ：3449556207）协助制作、Epeiuss（QQ：2822603942）与海藻酸钠（QQ：3409473369）监制\n\n欢迎各位进入开源仓库参与建设：https://gitee.com/coco-ag/coco-waddle/\n建议或特性反馈链接：https://www.yuque.com/forms/share/21daa75d-9aac-4887-8eb9-77dd20e658ec")
        console.log("V1.1-dev\n©️ 2022 CoCo Central, All rights reserved.")
    </script>

    <!--引入Blockly必要文件-->
    <script src="{{static_url('blockly-master/blockly_compressed.js')}}"></script>
    <script src="{{static_url('blockly-master/javascript_compressed.js')}}"></script>
    <script src="{{static_url('blockly-master/blocks_compressed.js')}}"></script>
    <script src="{{static_url('blockly-master/msg/js/zh-hans.js')}}"></script>

    <meta charset="utf-8">
    <link rel="shortcut icon" href="{{static_url('img/logo.png')}}">
    <title>Waddle - 让CoCo没有难做的控件</title>

    <!--图标库-->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0-beta3/css/all.css" rel="stylesheet">

    <!--定义Blocks-->
    <!-- <script src="static/blockly-master/blocks/invisibleWidget.js"></script> -->
    <!-- <script src="static/blockly-master/blocks/coco.js"></script> -->
    <script src="{{static_url('blockly-master/blocks/js.js')}}"></script>

    <!--Blocks 对应代码-->
    <!-- <script src="static/blockly-master/generators/javascript/invisibleWidget.js"></script> -->
    <!-- <script src="static/blockly-master/generators/javascript/coco.js"></script> -->
    <script src="{{static_url('blockly-master/generators/javascript/js.js')}}"></script>

    <!--引入框架-->
    <script src="{{static_url('js/jquery-3.4.1.min.js')}}"></script>
    <script src="{{static_url('js/bootstrap.bundle.min.js')}}"></script>
    <link href="{{static_url('css/bootstrap.min.css')}}" rel="stylesheet">


    <!--自定义Blockly样式-->
    <script src="{{static_url('Waddle/custom_category.js')}}"></script>
    <link href="{{static_url('css/blockly_style.css')}}" rel="stylesheet" />
    <!--包含toolbox和积木-->

    <!--自定义积木样式-->
    <script src="{{static_url('Waddle/custom_renderer.js')}}"></script>

    <!--自定义网格样式-->
    <script src="{{static_url('Waddle/custom_grid.js')}}"></script>

    <!--引入Waddle主题-->
    <script src="{{static_url('Waddle/core/theme/waddleTheme.js')}}"></script>

    <!--引入tools积木-->
    <script src="{{static_url('Waddle/blocks/tools.js')}}"></script>
    <script src="{{static_url('Waddle/generators/javascript/tools.js')}}"></script>

    <!--JavaScript积木-->
    <script src="{{static_url('blockly-master/blocks/js.js')}}"></script>
    <script src="{{static_url('blockly-master/generators/javascript/js.js')}}"></script>

    <!--JavaScript积木-->
    <script src="{{static_url('blockly-master/blocks/html.js')}}"></script>
    <script src="{{static_url('blockly-master/generators/javascript/html.js')}}"></script>


    <!--不可见控件积木-->
    <script src="{{static_url('Waddle/blocks/invisibleWidget.js')}}"></script>
    <script src="{{static_url('Waddle/generators/javascript/invisibleWidget.js')}}"></script>

    <!--导入导航栏按钮函数-->
    <script src="{{static_url('js/navFuncs.js')}}"></script>

    <!--彩蛋定义-->
    <script>
        function estchk(){
            if(document.cookie.includes("easter")){
                alert("恭喜，你貌似触发了彩蛋！");
                alert("马上去彩蛋！")
                window.location.href="/static/Waddle/eastegg/index.html";
            }else{
                document.cookie="easter=1";
            }
        }
    </script>

    <style>
        .nav-item {
            font-size: 25px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-sm navbar-dark" style="background-color: #6d50f0;">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><img src="{{static_url('img/waddle.svg')}}"
                    style="height: 28px;padding-left: 15px;padding-bottom: 3px;" alt="Waddle" onClick="estchk()"/></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a id="navbarDropdown" class="nav-link" href="#" role="button" title="" 
                        data-bs-toggle="dropdown" one-link-mark="yes"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="25" fill="currentColor" viewBox="0 0 130 125">
                            <path id="联合_1" data-name="联合 1" d="M7,125a7,7,0,0,1-7-7V57a7,7,0,0,1,7-7H123a7,7,0,0,1,7,7v61a7,7,0,0,1-7,7ZM4.667,35A4.667,4.667,0,0,1,0,30.334V7A7,7,0,0,1,7,0H48.823A20,20,0,0,1,68.6,17h48.067A13.334,13.334,0,0,1,130,30.334,4.667,4.667,0,0,1,125.333,35Z"/>
                          </svg></a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                            <li><a class="dropdown-item" href="javascript:void(0)" onClick="craft()">新建</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onClick="save()">保存到电脑</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onClick="openfile()">打开Waddle文件</a></li>
                            <div style="height: 1px;background-color: #f2f2f2;margin: 0 10px;"></div>
                            <li><a class="dropdown-item" href="javascript:void(0)" onClick="js_save()">另存为js文件</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a id="switch_table" class="nav-link active" href="javascript:void(0)" onclick="switch_table()"
                            title="工作区">
                            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor" viewBox="0 0 130 130">
                                <path id="积木" d="M130,114.534a5.122,5.122,0,0,1-5.117,5.212H58.948a4.857,4.857,0,0,0-3.667,1.538l-7.249,7.177A4.942,4.942,0,0,1,44.364,130H33.176a4.942,4.942,0,0,1-3.667-1.538l-7.249-7.177a4.772,4.772,0,0,0-3.582-1.538H5.118A5.122,5.122,0,0,1,0,114.534V72.923A5.122,5.122,0,0,1,5.118,67.8h13.39a5.2,5.2,0,0,1,3.667,1.453L29.509,76.6a4.942,4.942,0,0,0,3.667,1.538H44.364A4.942,4.942,0,0,0,48.031,76.6l7.334-7.348A5.2,5.2,0,0,1,59.033,67.8h65.849A5.122,5.122,0,0,1,130,72.923Zm-13.008-67.8a5.207,5.207,0,0,1-5.2,5.212H58.948a4.857,4.857,0,0,0-3.667,1.538l-7.249,7.177A4.942,4.942,0,0,1,44.364,62.2H33.176a4.942,4.942,0,0,1-3.667-1.538l-7.249-7.177a4.772,4.772,0,0,0-3.582-1.538H5.118A5.122,5.122,0,0,1,0,46.738V5.127A5.122,5.122,0,0,1,5.118,0h13.39a5.2,5.2,0,0,1,3.667,1.453L29.509,8.8a4.942,4.942,0,0,0,3.667,1.538H44.364A4.942,4.942,0,0,0,48.031,8.8l7.334-7.348A5.2,5.2,0,0,1,59.033,0h52.755a5.122,5.122,0,0,1,5.2,5.127Z" transform="translate(0 0)"/>
                              </svg>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a id="switch_code" class="nav-link" href="javascript:void(0)" title="转换代码">
                            <svg xmlns="http://www.w3.org/2000/svg" width="26" height="25" fill="currentColor" viewBox="0 0 130 125">
                                <path id="减去_1" data-name="减去 1" d="M123,125H7a7.008,7.008,0,0,1-7-7V7A7.008,7.008,0,0,1,7,0H123a7.008,7.008,0,0,1,7,7V118A7.008,7.008,0,0,1,123,125ZM69.814,69.944a7.008,7.008,0,0,0-7,7v1a7.008,7.008,0,0,0,7,7h36a7.008,7.008,0,0,0,7-7v-1a7.008,7.008,0,0,0-7-7ZM27.793,19.565a6.954,6.954,0,0,0-4.95,2.05l-.707.707a7,7,0,0,0,0,9.9L42.207,52.293,22.43,72.071a7.008,7.008,0,0,0,0,9.9l.706.707a7,7,0,0,0,9.9,0L58.492,57.222a7.008,7.008,0,0,0,0-9.9l-.707-.707c-.155-.155-.315-.3-.476-.435L32.743,21.615A6.954,6.954,0,0,0,27.793,19.565Z"/>
                              </svg>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://www.yuque.com/appcraft/widget-craft" title="关于"
                            target="_blank" onclick="count()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="27" height="27" fill="currentColor" viewBox="0 0 135 135">
                                <path id="circle-question-solid" d="M67.5,0A67.5,67.5,0,1,0,135,67.5,67.495,67.495,0,0,0,67.5,0Zm0,103.469a8.33,8.33,0,0,1-8.437-8.437A8.188,8.188,0,0,1,67.5,86.594a8.438,8.438,0,0,1,0,16.875ZM85.72,66.027,73.828,73.41v.527a6.328,6.328,0,0,1-12.656,0V69.719a6.5,6.5,0,0,1,3.164-5.537l15.029-8.965a5.653,5.653,0,0,0,2.9-5.01,6.062,6.062,0,0,0-6.038-5.8H62.754a5.7,5.7,0,0,0-5.8,5.8,6.328,6.328,0,0,1-12.656,0A18.293,18.293,0,0,1,62.517,31.75H75.99c10.758,0,18.932,8.174,18.932,18.457A18.517,18.517,0,0,1,85.72,66.027Z"/>
                              </svg>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="javascript:void(0)" title="主题" onclick="switch_theme()">
                            <i class="fa-solid fa-sun" id="theme"></i>
                        </a>
                    </li>
                    <!--菜单栏图标全由海藻酸钠绘制-->
                </ul>
            </div>
        </div>
    </nav>

    <div id="table">
        <div id="blocklyDiv" style="width:calc(100vw);"></div>
        <!--ToolBox积木-->
        <xml id="toolbox" style="display: none;width:calc(100vw);">
        </xml>
        <!--工作区积木-->
        <xml id="workspaceblocks" style="display: none">
        </xml>
    </div>
    <script>document.body.style.overflow='hidden' //禁止页面滑动</script>
    <script>
        //加载工作区
        //积木盒
        if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari，旧版IE代码已删除

            xmlhttp = new XMLHttpRequest();

        }
        else {
            alert('你就别用了吧！你这浏览器不行啊！换一个或升级，谢谢！')
        }

        xmlhttp.open("GET", "{{static_url('Waddle/toolBox.xml')}}", false);

        xmlhttp.send();

        xmlDoc = xmlhttp.responseXML;
        toolbox = document.getElementById('toolbox');
        toolbox.innerHTML = xmlDoc.getElementsByTagName('toolbox')[0].innerHTML;

        //工作区
        if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari，旧版IE代码已删除

            xmlhttp = new XMLHttpRequest();

        }
        else {
            alert('你就别用了吧！你这浏览器不行啊！换一个或升级，谢谢！')
        }
        xmlhttp.open("GET", "{{static_url('Waddle/workspace.xml')}}", false);

        xmlhttp.send();

        xmlDoc = xmlhttp.responseXML;
        workspaceblocks = document.getElementById('workspaceblocks');
        workspaceblocks.innerHTML = xmlDoc.getElementsByTagName('workspaceblocks')[0].innerHTML;

        var workspaceBlocks = document.getElementById("workspaceblocks");

        //定义主题
        var theme = WaddleTheme;
        //工作区
        var workspace = Blockly.inject('blocklyDiv',
            {
                toolbox: document.getElementById('toolbox'),
                grid: CustomGrid,
                zoom:
                {
                    controls: true,
                    wheel: true,
                    startScale: 0.8,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                theme: theme,
                renderer: 'zelos' //scratch风格，自定义的是custom_renderer
            });

        /* 加载初始积木 */
        Blockly.Xml.domToWorkspace(workspaceBlocks, workspace);

    </script>
    <script>
        //各种函数
        /* 搬迁了，在static/js/navFuncs.js */
        let getjscode = function () {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            alert(code);
        };

        window.onbeforeunload = function () {
            return "离开后，你的控件就没啦！";
        }
        // document.getElementById('read').addEventListener('change', function selectedFileChanged() {
        //     if (this.files.length !== 0) {
        //         workspace.clear()
        //         const reader = new FileReader();
        //         reader.onload = function fileReadCompleted() {
        //             const xml = Blockly.Xml.textToDom(reader.result);
        //             Blockly.Xml.domToWorkspace(xml, workspace);
        //         };
        //         reader.readAsText(this.files[0]);
        //     }
        // });
    </script>
    <script>
        //彩蛋
        /* 搬迁了，在static/js/navFuncs.js */
    </script>
    <script>
        window.onresize = function(){
            document.getElementById("table").style.height = (document.body.clientHeight-57)
            document.getElementById("toolbox").style.height = (document.body.clientHeight-57)
            Blockly.svgResize(workspace);
        }
    </script>
    <script>
        document.getElementById("table").style.height = (document.body.clientHeight - 57)
        document.getElementById("toolbox").style.height = (document.body.clientHeight - 57)
        Blockly.svgResize(workspace);
        var dark_url = "{{static_url('Waddle/custom_category_dark.js')}}"
        var light_url = "{{static_url('Waddle/custom_category.js')}}"
        if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari，旧版IE代码已删除
            xmlhttp = new XMLHttpRequest();
        }
        else {
            alert('你就别用了吧！你这浏览器不行啊！换一个或升级，谢谢！')
        }
        xmlhttp.open("GET", dark_url, false);
        xmlhttp.send();
        dark = xmlhttp.responseText;
        xmlhttp.open("GET", light_url, false);
        xmlhttp.send();
        light = xmlhttp.responseText;
        var to_dark = function () {
            document.getElementsByTagName("nav")[0].style.backgroundColor = "#525252"
            workspace.setTheme(DarkTheme);
            eval(dark)
            //有bug，哪位大好人修一下
        }
        var to_light = function () {
            document.getElementsByTagName("nav")[0].style.backgroundColor = "#6d50f0"
            workspace.setTheme(WaddleTheme);
            eval(light)
        }
        var theme = "light"
        var switch_theme = function(){
            if (theme == "light"){
                document.getElementById("theme").className = "fa-solid fa-moon"
                to_dark()
                theme = "dark"
            }else{
                document.getElementById("theme").className = "fa-solid fa-sun"
                to_light()
                theme = "light"
            }
        }
        window.onresize = function () {
            document.getElementById("table").style.height = (document.body.clientHeight - 57)
            document.getElementById("toolbox").style.height = (document.body.clientHeight - 57)
            Blockly.svgResize(workspace);
        }
    </script>
    <a href="" download="" style="display: none;" id="downa" aria-label="下载"></a>
    <style>
        .js_button {
            padding: 10px;
        }

        .nav {
            height: 5%;
        }

        .nav-item {
            height: 5%;
            margin-left: 20px;
        }

        .nav-link {
            height: 5%;
        }

        *::-webkit-scrollbar {
	        display: none;
        }
        
        * {
	        scrollbar-width: none;
	        -ms-overflow-style: none;  
        }
    </style>
<!-- 代码框 -->
<div id="myModal" class="modal">
<!-- 代码框内容 -->
  <div class="modal-content">
	  <div class="modal-header">
	    <span>转换代码浏览</span>
        <span class="close">&times;</span>
	  </div>
	  <div class="modal-body">
	    <textarea readonly id="codeArea"></textarea>
	  </div>
  </div>
</div>
<style>
#codeArea{
    height: 92vh;
    width: 100%;
    resize:none;
}
/* 代码框 (background) */
.modal {
    display: none; /* 默认隐藏 */
    position: fixed;  
    z-index: 1000;
    top:0;
    left: 75vw;
    width: 25%; 
    height: 100%; 
    overflow: hidden; 
    float: right;
}

/* 代码框内容 */
.modal-content {
    position: relative;
    background-color: #fefefe;
    margin:0 auto;
    padding: 0;
    border: 1px solid #888;
    width: 100%;
    box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
    -webkit-animation-name: animatetop;
    -webkit-animation-duration: 0.4s;
    animation-name: animatetop;
    animation-duration: 0.4s
}

/* 添加动画 */
@-webkit-keyframes animatetop {
    from {right:-300px; opacity:0} 
    to {right:0; opacity:1}
}

@keyframes animatetop {
    from {right:-300px; opacity:0}
    to {right:0; opacity:1}
}

/* 关闭按钮 */
.close {
    color: white;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
    cursor: pointer;
}

.modal-header {
    padding: 8px 16px;
    background-color: #6d50f0;
    color: white;
}

.modal-body {
    padding: 2px 16px;
    overflow-y:auto;
    height: 75%;
}

</style>
<script>

function myUpdateFunction(event) {
  var code = Blockly.JavaScript.workspaceToCode(workspace);
  document.getElementById("codeArea").innerHTML = code;
}
workspace.addChangeListener(myUpdateFunction);

var modal = document.getElementById('myModal');

// 打开代码框的按钮对象
var btn = document.getElementById("switch_code");

// 获取 <span> 元素，用于关闭弹窗 that closes the modal
var span = document.getElementsByClassName("close")[0];

// 点击按钮打开代码框
btn.onclick = function() {
    modal.style.display = "block";
}

// 点击 <span> (x), 关闭代码框
span.onclick = function() {
    modal.style.display = "none";
}
</script>
</body>
</html>