<html lang="zh">

<head>
    <script>
        var a = `
                                                                                       
                    ::::::::::::::               :               ffffffffffffff              
                    :::::::::;;;;;              ::              ffffffffffffff               
                    ,;;;;;;;;;;;;;             ::::            ffffffffffffff                
                    ;;;;;;;;;;;;;;           :::::           .ttttttttfffff,                 
                        ;;;;;;;;;;;;;:         ::::::;          tttttttttttttt               
                        ;;;;;;;;;;;;;;         ::::;;;;        1ttttttttttttt                
                        ;;;;;;;;;;;;;;       ::::;;;;;i       tttttttttttttt                 
                        ;;;;;;;;;;;;;;      ::::;;;;;ii      tttttttttttttt                  
                        ;;;;;;;;;;;;;;    ::::;;;;;iiii     11111111tttttt                   
                        :;;;;;;;;;;;;;    ::;;;;;;iiiii1   11111111111111                    
                        ;;;;;;;;iiiiii  ::;;;;;;iiiii111  1111111111111:                     
                            iiiiiiiiiiiii ::;;;;;iiiiii1111,11111111111111                
                            iiiiiiiiiiiii::;;;;;iiiii111111t1111111111111                    
                            iiiiiiiiiiii:;;;;;iiiii111111tiiiiiiii111111                     
                            iiiiiiiiiii;;;;;;iiiii11111tttiiiiiiiiiiiii                      
                            iiiiiiiii;;;;;iiiiii11111tttiiiiiiiiiiiiii                       
                            iiiiiiii;;;;;iiiiii11111ttttiiiiiiiiiiiii                        
                            iiiiiii;;;;iiiii111111ttttiiiiiiiiiiiii;                         
                                iiiii;;;;iiiii1111 ttttti;;;;;;iiiiiii                       
                                iiii;;;;iiiii1111   tttt;;;;;;;;;;;;;                        
                                ii;;;iiiiii11111    tt;;;;;;;;;;;;;;                        
                                ii;;iiiii111111      t;;;;;;;;;;;;;                          
        `
        console.log(a)
        console.log("嘿，欢迎使用 WidgetCraft!\n本工具基于Blockly开发，由 中子星000（QQ：2422481178）主理制作、MathCalculus（QQ：2504556268）协助制作、Epeiuss（QQ：2822603942）与海藻酸钠（QQ：3409473369）监制\n\n欢迎各位进入开源仓库参与建设：https://gitee.com/coco-ag/coco-widgetcraft/\n建议或特性反馈链接：https://www.yuque.com/forms/share/21daa75d-9aac-4887-8eb9-77dd20e658ec")
    </script>

    <!--引入Blockly必要文件-->
    <script src="{{static_url('blockly-master/blockly_compressed.js')}}"></script>
    <script src="{{static_url('blockly-master/javascript_compressed.js')}}"></script>
    <script src="{{static_url('blockly-master/blocks_compressed.js')}}"></script>
    <script src="{{static_url('blockly-master/msg/js/zh-hans.js')}}"></script>

    <meta charset="utf-8">
    <link rel="shortcut icon" href="{{static_url('img/favicon.ico')}}">
    <title>Widget - 让CoCo没有难做的控件</title>
    <!--定义Blocks-->
    <!-- <script src="static/blockly-master/blocks/invisibleWidget.js"></script> -->
    <!-- <script src="static/blockly-master/blocks/coco.js"></script> -->
    <script src="{{static_url('blockly-master/blocks/js.js')}}"></script>

    <!--Blocks 对应代码-->
    <!-- <script src="static/blockly-master/generators/javascript/invisibleWidget.js"></script> -->
    <!-- <script src="static/blockly-master/generators/javascript/coco.js"></script> -->
    <script src="{{static_url('blockly-master/generators/javascript/js.js')}}"></script>

    <!--引入框架-->
    <script src="{{static_url('js/jquery-3.4.1.min.js')}}"></script>
    <script src="{{static_url('js/bootstrap.bundle.min.js')}}"></script>
    <link href="{{static_url('css/bootstrap.min.css')}}" rel="stylesheet">


    <!--自定义Blockly样式-->
    <script src="{{static_url('WidgetCraft/custom_category.js')}}"></script>
    <link href="{{static_url('css/blockly_style.css')}}" rel="stylesheet" />
    <!--包含toolbox和积木-->

    <!--自定义积木样式-->
    <script src="{{static_url('WidgetCraft/custom_renderer.js')}}"></script>

    <!--自定义网格样式-->
    <script src="{{static_url('WidgetCraft/custom_grid.js')}}"></script>

    <!--引入WidgetCraft主题-->
    <script src="{{static_url('WidgetCraft/core/theme/widgetCraftTheme.js')}}"></script>

    <!--引入tools积木-->
    <script src="{{static_url('WidgetCraft/blocks/tools.js')}}"></script>
    <script src="{{static_url('WidgetCraft/generators/javascript/tools.js')}}"></script>

    <!--JavaScript积木-->
    <script src="{{static_url('blockly-master/blocks/js.js')}}"></script>
    <script src="{{static_url('blockly-master/generators/javascript/js.js')}}"></script>

    <!--JavaScript积木-->
    <script src="{{static_url('blockly-master/blocks/html.js')}}"></script>
    <script src="{{static_url('blockly-master/generators/javascript/html.js')}}"></script>


    <!--不可见控件积木-->
    <script src="{{static_url('WidgetCraft/blocks/invisibleWidget.js')}}"></script>
    <script src="{{static_url('WidgetCraft/generators/javascript/invisibleWidget.js')}}"></script>

    <style>
        .nav-item {
            font-size: 20px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-sm navbar-dark" style="background-color: #6d50f0;">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><img src="{{static_url('img/widget.png')}}"
                    style="height: 40px;padding-left: 15px;padding-bottom: 5px;" alt="WidgetCraft" /></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor"
                                class="bi bi-folder" viewBox="0 0 16 16">
                                <path
                                    d="M.54 3.87.5 3a2 2 0 0 1 2-2h3.672a2 2 0 0 1 1.414.586l.828.828A2 2 0 0 0 9.828 3h3.982a2 2 0 0 1 1.992 2.181l-.637 7A2 2 0 0 1 13.174 14H2.826a2 2 0 0 1-1.991-1.819l-.637-7a1.99 1.99 0 0 1 .342-1.31zM2.19 4a1 1 0 0 0-.996 1.09l.637 7a1 1 0 0 0 .995.91h10.348a1 1 0 0 0 .995-.91l.637-7A1 1 0 0 0 13.81 4H2.19zm4.69-1.707A1 1 0 0 0 6.172 2H2.5a1 1 0 0 0-1 .981l.006.139C1.72 3.042 1.95 3 2.19 3h5.396l-.707-.707z" />
                            </svg>
                        </a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                            <li><a class="dropdown-item" href="javascript:void(0)" onClick="craft()">新建</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onClick="save()">保存</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)"><input type="file" id="read"
                                        name="打开" style="width: 167;"></input></a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a id="switch_table" class="nav-link active" href="javascript:void(0)" onclick="switch_table()" title="工作区"><svg
                                xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor"
                                class="bi bi-laptop" viewBox="0 0 16 16">
                                <path
                                    d="M13.5 3a.5.5 0 0 1 .5.5V11H2V3.5a.5.5 0 0 1 .5-.5h11zm-11-1A1.5 1.5 0 0 0 1 3.5V12h14V3.5A1.5 1.5 0 0 0 13.5 2h-11zM0 12.5h16a1.5 1.5 0 0 1-1.5 1.5h-13A1.5 1.5 0 0 1 0 12.5z" />
                            </svg></a>
                    </li>
                    <li class="nav-item">
                        <a id="switch_code" class="nav-link" href="javascript:void(0)" onclick="switch_code()" title="转换代码"><svg
                                xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor"
                                class="bi bi-save2" viewBox="0 0 16 16">
                                <path
                                    d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v4.5h2a.5.5 0 0 1 .354.854l-2.5 2.5a.5.5 0 0 1-.708 0l-2.5-2.5A.5.5 0 0 1 5.5 6.5h2V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z" />
                            </svg></a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://www.yuque.com/appcraft/widget-craft" title="关于" target="_blank" onclick="count()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25"
                                fill="currentColor" class="bi bi-question-circle" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                <path
                                    d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z" />
                            </svg></a>
                    </li>
                    <!--
                    文件：
                    https://icons.bootcss.com/icons/folder/
                    https://icons.bootcss.com/icons/folder-fill/
                    工作台：https://icons.bootcss.com/icons/laptop/
                    https://icons.bootcss.com/icons/laptop-fill/
                    代码icon：
                    https://icons.bootcss.com/icons/save2/
                    https://icons.bootcss.com/icons/save2-fill/
                    关于icon：https://icons.bootcss.com/icons/question-circle/
                    https://icons.bootcss.com/icons/question-circle-fill/
                -->
                </ul>
            </div>
        </div>
    </nav>
    <div id="table">
        <div id="blocklyDiv" style="width:100%;height: 94%;"></div>
        <!--ToolBox积木-->
        <xml id="toolbox" style="display: none">
        </xml>
        <!--工作区积木-->
        <xml id="workspaceblocks" style="display: none">
        </xml>
    </div>
    <div id="code" style="display: none;height: 95%;width: 100%;padding: 5px">
        <textarea id="codeArea" style="height: 100%;width: 100%;padding: 5px"></textarea>
    </div>
    <script>
        //加载工作区
        if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari，旧版IE代码已删除

            xmlhttp = new XMLHttpRequest();

        }
        else {
            alert('你就别用了吧！你这浏览器不行啊！换一个或升级，谢谢！')
        }

        xmlhttp.open("GET", "{{static_url('WidgetCraft/toolBox.xml')}}", false);

        xmlhttp.send();

        xmlDoc = xmlhttp.responseXML;
        toolbox = document.getElementById('toolbox');
        toolbox.innerHTML = xmlDoc.getElementsByTagName('toolbox')[0].innerHTML;


        if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari，旧版IE代码已删除

            xmlhttp = new XMLHttpRequest();

        }
        else {
            alert('你就别用了吧！你这浏览器不行啊！换一个或升级，谢谢！')
        }
        xmlhttp.open("GET", "{{static_url('WidgetCraft/workspace.xml')}}", false);

        xmlhttp.send();

        xmlDoc = xmlhttp.responseXML;
        workspaceblocks = document.getElementById('workspaceblocks');
        workspaceblocks.innerHTML = xmlDoc.getElementsByTagName('workspaceblocks')[0].innerHTML;

        var workspaceBlocks = document.getElementById("workspaceblocks");

        //定义主题
        var theme = widgetCraftTheme;
        //工作区
        var workspace = Blockly.inject('blocklyDiv',
            {
                toolbox: document.getElementById('toolbox'),
                grid: CustomGrid,
                zoom:
                {
                    controls: true,
                    wheel: true,
                    startScale: 0.8,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                theme: theme,
                renderer: 'zelos' //scratch风格，自定义的是custom_renderer
            });

        /* 加载初始积木 */
        Blockly.Xml.domToWorkspace(workspaceBlocks, workspace);

    </script>
    <script>
        //各种函数
        let getjscode = function () {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            alert(code);
        };
        let switch_table = function () {
            var code = document.getElementById("code")
            code.style.display = "none";
            var table = document.getElementById("table")
            table.style.display = "inline";

            $('.switch_table').addClass('active');
            $('.switch_code').removeClass('active');
        }
        let switch_code = function () {
            var code = document.getElementById("code")
            code.style.display = "inline";
            var table = document.getElementById("table")
            table.style.display = "none";
            var codeArea = document.getElementById("codeArea")
            codeArea.innerHTML = Blockly.JavaScript.workspaceToCode(workspace);

            $('.switch_table').removeClass('active');
            $('.switch_code').addClass('active');
            
        }
        window.onbeforeunload = function () {
            return "离开后，你的控件就没啦！";
        }
        let save = function () {
            let code_xml = Blockly.Xml.workspaceToDom(workspace);
            let code_data = Blockly.Xml.domToText(code_xml);
            let blob = new Blob([code_data], { type: "text/plain;charset=utf-8" });
            let url = URL.createObjectURL(blob);
            let downa = document.getElementById("downa");
            downa.href = url;
            downa.click();
            URL.revokeObjectURL(url);
        }


        let craft = function () {
            workspace.clear();
            /* 加载初始积木 */
            Blockly.Xml.domToWorkspace(workspaceBlocks, workspace);
            alert('这里放一个向导');
        }


        document.getElementById('read').addEventListener('change', function selectedFileChanged() {
            if (this.files.length !== 0) {
                workspace.clear()
                const reader = new FileReader();
                reader.onload = function fileReadCompleted() {
                    const xml = Blockly.Xml.textToDom(reader.result);
                    Blockly.Xml.domToWorkspace(xml, workspace);
                };
                reader.readAsText(this.files[0]);
            }
        });
    </script>
    <script>
        //彩蛋
        var get_num = 0;
        let count = function () {
            get_num++;
            if (get_num >= 5) {
                window.open("{{static_url('WidgetCraft/aiwidget.html')}}")
                get_num = -999;
            }
        }
    </script>
    <a href="" download="CocoWidget.cw" style="display: none;" id="downa" aria-label="下载"></a>
    <style>
        .js_button {
            padding: 10px;
        }

        .nav {
            height: 5%;
        }

        .nav-item {
            height: 5%;
        }

        .nav-link {
            height: 5%;
        }
    </style>
</body>

</html>