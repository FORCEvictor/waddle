<html lang="zh">
<!--
    BUG1:高亮未处理
    TODO1:新建窗口
    TODO2:自定义控件及附属功能
    TODO3:代码窗
-->


<head>
    <script>
        /*var a = `
                                                                                       
                    ::::::::::::::               :               ffffffffffffff              
                    :::::::::;;;;;              ::              ffffffffffffff               
                    ,;;;;;;;;;;;;;             ::::            ffffffffffffff                
                    ;;;;;;;;;;;;;;           :::::           .ttttttttfffff,                 
                        ;;;;;;;;;;;;;:         ::::::;          tttttttttttttt               
                        ;;;;;;;;;;;;;;         ::::;;;;        1ttttttttttttt                
                        ;;;;;;;;;;;;;;       ::::;;;;;i       tttttttttttttt                 
                        ;;;;;;;;;;;;;;      ::::;;;;;ii      tttttttttttttt                  
                        ;;;;;;;;;;;;;;    ::::;;;;;iiii     11111111tttttt                   
                        :;;;;;;;;;;;;;    ::;;;;;;iiiii1   11111111111111                    
                        ;;;;;;;;iiiiii  ::;;;;;;iiiii111  1111111111111:                     
                            iiiiiiiiiiiii ::;;;;;iiiiii1111,11111111111111                
                            iiiiiiiiiiiii::;;;;;iiiii111111t1111111111111                    
                            iiiiiiiiiiii:;;;;;iiiii111111tiiiiiiii111111                     
                            iiiiiiiiiii;;;;;;iiiii11111tttiiiiiiiiiiiii                      
                            iiiiiiiii;;;;;iiiiii11111tttiiiiiiiiiiiiii                       
                            iiiiiiii;;;;;iiiiii11111ttttiiiiiiiiiiiii                        
                            iiiiiii;;;;iiiii111111ttttiiiiiiiiiiiii;                         
                                iiiii;;;;iiiii1111 ttttti;;;;;;iiiiiii                       
                                iiii;;;;iiiii1111   tttt;;;;;;;;;;;;;                        
                                ii;;;iiiiii11111    tt;;;;;;;;;;;;;;                        
                                ii;;iiiii111111      t;;;;;;;;;;;;;                          
        `
        console.log(a)*/
        //暂时按照小王的意，移除了W
        console.log("嘿，欢迎使用 Waddle!\n本工具基于Blockly开发，由 中子星000（QQ：2422481178）主理制作、MathCalculus（QQ：2504556268）协助制作、Epeiuss（QQ：2822603942）与海藻酸钠（QQ：3409473369）监制\n\n欢迎各位进入开源仓库参与建设：https://gitee.com/coco-ag/coco-waddle/\n建议或特性反馈链接：https://www.yuque.com/forms/share/21daa75d-9aac-4887-8eb9-77dd20e658ec")
        console.log("V1.1-dev\n©️ 2022 CoCo Central, All rights reserved.")
    </script>

    <!--引入Blockly必要文件-->
    <script src="{{static_url('blockly-master/blockly_compressed.js')}}"></script>
    <script src="{{static_url('blockly-master/javascript_compressed.js')}}"></script>
    <script src="{{static_url('blockly-master/blocks_compressed.js')}}"></script>
    <script src="{{static_url('blockly-master/msg/js/zh-hans.js')}}"></script>

    <meta charset="utf-8">
    <link rel="shortcut icon" href="{{static_url('img/logo.png')}}">
    <title>Waddle - 让CoCo没有难做的控件</title>

    <!--图标库-->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/6.0.0-beta3/css/all.css" rel="stylesheet">

    <!--定义Blocks-->
    <!-- <script src="static/blockly-master/blocks/invisibleWidget.js"></script> -->
    <!-- <script src="static/blockly-master/blocks/coco.js"></script> -->
    <script src="{{static_url('blockly-master/blocks/js.js')}}"></script>

    <!--Blocks 对应代码-->
    <!-- <script src="static/blockly-master/generators/javascript/invisibleWidget.js"></script> -->
    <!-- <script src="static/blockly-master/generators/javascript/coco.js"></script> -->
    <script src="{{static_url('blockly-master/generators/javascript/js.js')}}"></script>

    <!--引入框架-->
    <script src="{{static_url('js/jquery-3.4.1.min.js')}}"></script>
    <script src="{{static_url('js/bootstrap.bundle.min.js')}}"></script>
    <link href="{{static_url('css/bootstrap.min.css')}}" rel="stylesheet">


    <!--自定义Blockly样式-->
    <script src="{{static_url('Waddle/custom_category.js')}}"></script>
    <link href="{{static_url('css/blockly_style.css')}}" rel="stylesheet" />
    <!--包含toolbox和积木-->

    <!--自定义积木样式-->
    <script src="{{static_url('Waddle/custom_renderer.js')}}"></script>

    <!--自定义网格样式-->
    <script src="{{static_url('Waddle/custom_grid.js')}}"></script>

    <!--引入Waddle主题-->
    <script src="{{static_url('Waddle/core/theme/waddleTheme.js')}}"></script>

    <!--引入tools积木-->
    <script src="{{static_url('Waddle/blocks/tools.js')}}"></script>
    <script src="{{static_url('Waddle/generators/javascript/tools.js')}}"></script>

    <!--JavaScript积木-->
    <script src="{{static_url('blockly-master/blocks/js.js')}}"></script>
    <script src="{{static_url('blockly-master/generators/javascript/js.js')}}"></script>

    <!--JavaScript积木-->
    <script src="{{static_url('blockly-master/blocks/html.js')}}"></script>
    <script src="{{static_url('blockly-master/generators/javascript/html.js')}}"></script>


    <!--不可见控件积木-->
    <script src="{{static_url('Waddle/blocks/invisibleWidget.js')}}"></script>
    <script src="{{static_url('Waddle/generators/javascript/invisibleWidget.js')}}"></script>

    <!--导入导航栏按钮函数-->
    <script src="{{static_url('js/navFuncs.js')}}"></script>

    <!--彩蛋定义-->
    <script>
        function estchk(){
            if(document.cookie.includes("easter")){
                alert("恭喜，你貌似触发了彩蛋！");
                alert("马上去彩蛋！")
                window.location.href="/static/Waddle/eastegg/index.html";
            }else{
                document.cookie="easter=1";
            }
        }
    </script>

    <style>
        .nav-item {
            font-size: 25px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-sm navbar-dark" style="background-color: #6d50f0;">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><img src="{{static_url('img/waddle.svg')}}"
                    style="height: 28px;padding-left: 15px;padding-bottom: 5px;" alt="Waddle" onClick="estchk()"/></a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
                aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a id="navbarDropdown" class="nav-link dropdown-toggle" href="#" role="button" title="" 
                        data-bs-toggle="dropdown" one-link-mark="yes"><i class="fa-solid fa-folder"></i></a>
                        <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                            <li><a class="dropdown-item" href="javascript:void(0)" onClick="craft()">新建</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onClick="save()">保存</a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onClick="openfile()">打开</a></li>
                        </ul>
                    </li>
                    <li class="nav-item">
                        <a id="switch_table" class="nav-link active" href="javascript:void(0)" onclick="switch_table()"
                            title="工作区">
                            <svg t="1644662826288"
                             width="25" height="25" fill="currentColor" viewBox="0 0 1417 1024"><path d="M1416.996109 905.971466a38.910506 38.910506 0 0 1-38.910506 39.559014H566.801556a36.964981 36.964981 0 0 0-27.885862 11.673152l-55.123217 54.474708a37.613489 37.613489 0 0 1-27.885862 11.673152H252.274968a37.613489 37.613489 0 0 1-27.885863-11.673152l-55.123217-54.474708a36.316472 36.316472 0 0 0-27.237354-11.673152H38.915694a38.910506 38.910506 0 0 1-38.910506-39.559014V590.14786a38.910506 38.910506 0 0 1 38.910506-38.910506h101.815824a39.559014 39.559014 0 0 1 27.885862 11.024643l55.771725 55.771725a37.613489 37.613489 0 0 0 27.885863 11.673152h203.631647a37.613489 37.613489 0 0 0 27.885862-11.673152l55.771725-55.771725a39.559014 39.559014 0 0 1 27.885863-11.024643h810.635538a38.910506 38.910506 0 0 1 38.910506 38.910506zM1023.351492 354.7393a39.559014 39.559014 0 0 1-39.559015 39.559014H566.801556a36.964981 36.964981 0 0 0-27.885862 11.673152l-55.123217 54.474708a37.613489 37.613489 0 0 1-27.885862 11.673152H252.274968a37.613489 37.613489 0 0 1-27.885863-11.673152l-55.123217-54.474708a36.316472 36.316472 0 0 0-27.237354-11.673152H38.915694a38.910506 38.910506 0 0 1-38.910506-39.559014V38.915694A38.910506 38.910506 0 0 1 38.915694 0.005188h101.815824a39.559014 39.559014 0 0 1 27.885862 11.024643l55.771725 55.771725a37.613489 37.613489 0 0 0 27.885863 11.673152h203.631647a37.613489 37.613489 0 0 0 27.885862-11.673152l55.771725-55.771725A39.559014 39.559014 0 0 1 567.450065 0.005188h416.342412a38.910506 38.910506 0 0 1 39.559015 38.910506z" p-id="6649"></path></svg>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a id="switch_code" class="nav-link" href="javascript:void(0)" onclick="switch_code()"
                            title="转换代码">
                            <i class="fa-solid fa-code"></i>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="https://www.yuque.com/appcraft/widget-craft" title="关于"
                            target="_blank" onclick="count()">
                            <i class="fa-solid fa-circle-question"></i>
                        </a>
                    </li>
                    <!--
                        文件
                            https://icons.bootcss.com/icons/folder/
                            https://icons.bootcss.com/icons/folder-fill/
                        工作台
                            https://icons.bootcss.com/icons/laptop/
                            https://icons.bootcss.com/icons/laptop-fill/
                        代码icon
                            https://icons.bootcss.com/icons/save2/
                            https://icons.bootcss.com/icons/save2-fill/
                        关于icon  
                            https://icons.bootcss.com/icons/question-circle/
                            https://icons.bootcss.com/icons/question-circle-fill/
                    -->
                </ul>
            </div>
        </div>
    </nav>

    <div id="table">
        <div id="blocklyDiv" style="width:100%;height: 94%;"></div>
        <!--ToolBox积木-->
        <xml id="toolbox" style="display: none">
        </xml>
        <!--工作区积木-->
        <xml id="workspaceblocks" style="display: none">
        </xml>
    </div>
    <div id="code" style="display: none;height: 95%;width: 100%;padding: 5px">
        <textarea id="codeArea" style="height: 100%;width: 100%;padding: 5px"></textarea>
    </div>
    <script>
        //加载工作区
        //积木盒
        if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari，旧版IE代码已删除

            xmlhttp = new XMLHttpRequest();

        }
        else {
            alert('你就别用了吧！你这浏览器不行啊！换一个或升级，谢谢！')
        }

        xmlhttp.open("GET", "{{static_url('Waddle/toolBox.xml')}}", false);

        xmlhttp.send();

        xmlDoc = xmlhttp.responseXML;
        toolbox = document.getElementById('toolbox');
        toolbox.innerHTML = xmlDoc.getElementsByTagName('toolbox')[0].innerHTML;

        //工作区
        if (window.XMLHttpRequest) {// code for IE7+, Firefox, Chrome, Opera, Safari，旧版IE代码已删除

            xmlhttp = new XMLHttpRequest();

        }
        else {
            alert('你就别用了吧！你这浏览器不行啊！换一个或升级，谢谢！')
        }
        xmlhttp.open("GET", "{{static_url('Waddle/workspace.xml')}}", false);

        xmlhttp.send();

        xmlDoc = xmlhttp.responseXML;
        workspaceblocks = document.getElementById('workspaceblocks');
        workspaceblocks.innerHTML = xmlDoc.getElementsByTagName('workspaceblocks')[0].innerHTML;

        var workspaceBlocks = document.getElementById("workspaceblocks");

        //定义主题
        var theme = WaddleTheme;
        //工作区
        var workspace = Blockly.inject('blocklyDiv',
            {
                toolbox: document.getElementById('toolbox'),
                grid: CustomGrid,
                zoom:
                {
                    controls: true,
                    wheel: true,
                    startScale: 0.8,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                theme: theme,
                renderer: 'zelos' //scratch风格，自定义的是custom_renderer
            });

        /* 加载初始积木 */
        Blockly.Xml.domToWorkspace(workspaceBlocks, workspace);

    </script>
    <script>
        //各种函数
        /* 搬迁了，在static/js/navFuncs.js */
        let getjscode = function () {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            alert(code);
        };

        window.onbeforeunload = function () {
            return "离开后，你的控件就没啦！";
        }
        // document.getElementById('read').addEventListener('change', function selectedFileChanged() {
        //     if (this.files.length !== 0) {
        //         workspace.clear()
        //         const reader = new FileReader();
        //         reader.onload = function fileReadCompleted() {
        //             const xml = Blockly.Xml.textToDom(reader.result);
        //             Blockly.Xml.domToWorkspace(xml, workspace);
        //         };
        //         reader.readAsText(this.files[0]);
        //     }
        // });
    </script>
    <script>
        //彩蛋
        /* 搬迁了，在static/js/navFuncs.js */
    </script>
    <a href="" download="CocoWidget.waddle" style="display: none;" id="downa" aria-label="下载"></a>
    <style>
        .js_button {
            padding: 10px;
        }

        .nav {
            height: 5%;
        }

        .nav-item {
            height: 5%;
            margin-left: 20px;
        }

        .nav-link {
            height: 5%;
        }

        ::-webkit-scrollbar {
            display: none;
            scrollbar-width: none;
        }
    </style>
</body>

</html>