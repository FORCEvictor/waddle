<html lang="zh">

<head>
    <!--引入Blockly必要文件-->
    <script src="static/blockly-master/blockly_compressed.js"></script>
    <script src="static/blockly-master/javascript_compressed.js"></script>
    <script src="static/blockly-master/blocks_compressed.js"></script>
    <script src="static/blockly-master/msg/js/zh-hans.js"></script>

    <meta charset="utf-8">
    <title>Widget 工匠</title>
    <!--定义Blocks-->
    <script src="static/blockly-master/blocks/invisibleWidget.js"></script>
    <script src="static/blockly-master/blocks/coco.js"></script>
    <script src="static/blockly-master/blocks/js.js"></script>

    <!--Blocks 对应代码-->
    <script src="static/blockly-master/generators/javascript/invisibleWidget.js"></script>
    <script src="static/blockly-master/generators/javascript/coco.js"></script>
    <script src="static/blockly-master/generators/javascript/js.js"></script>

    <!--引入框架-->
    <script src="static/js/jquery-3.4.1.min.js"></script>
    <script src="static/js/bootstrap.bundle.min.js"></script>
    <link href="static/css/bootstrap.min.css" rel="stylesheet">


    <!--自定义Blockly样式-->
    <script src="static/WidgetCraft/custom_category.js"></script>
    <link href="static/css/blockly_style.css" rel="stylesheet" /><!--包含toolbox和积木-->

    <!--自定义积木样式-->
    <script src="static/WidgetCraft/custom_renderer.js"></script>

    <!--引入WidgetCraft主题-->
    <script src="static/WidgetCraft/core/theme/widgetCraftTheme.js"></script>
    <!--引入tools积木-->
    <script src="static/WidgetCraft/blocks/tools.js"></script>
    <!--引入tools生成器-->
    <script src="static/WidgetCraft/generators/javascript/tools.js"></script>

    <style>
        .nav-item {
            font-size: 20px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-sm navbar-dark" style="background-color: #6d50f0;">
        <!--导航栏-->
        <!-- Brand -->
        <a class="navbar-brand" href="#"><img src="static/img/widget.png"
                style="height: 40px;padding-left: 15px;padding-bottom: 5px;" alt="WidgetCraft" /></a>
        <!-- Links -->
        <ul class="navbar-nav">
            <!-- Dropdown -->
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    文件
                </a>
                <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                  <li><a class="dropdown-item" href="javascript:void(0)" onClick="craft()">新建</a></li>
                  <li><a class="dropdown-item" href="javascript:void(0)" onClick="save()">保存</a></li>
                  <li><a class="dropdown-item" href="javascript:void(0)"><input type="file" id="read" name="打开" style="width: 167;"></input></a></li>
                </ul>
              </li>
            <li class="nav-item">
                <a class="nav-link" href="javascript:void(0)" onclick="switch_table()">工作台</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="javascript:void(0)" onclick="switch_code()">代码生成</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="https://www.yuque.com/appcraft/widget-craft/about" target="_blank">关于</a>
            </li>
        </ul>
    </nav>
    <div id="table">
        <div id="blocklyDiv" style="width:100%;height: 94%;"></div>
        <!--ToolBox积木-->
        <xml id="toolbox" style="display: none">
            <!-- <category name="基本积木" colour="#9429FF"> --><!--样式不对，暂时不用文件夹-->
            <category name="控制" colour="#68CDFF">
                <block type="controls_whileUntil"></block>
                <block type="controls_repeat_ext">
                    <value name="TIMES">
                        <block type="math_number">
                            <field name="NUM">10</field>
                        </block>
                    </value>
                </block>
                <block type="controls_whileUntil"></block>
                <block type="controls_for">
                    <field name="VAR">i</field>
                    <value name="FROM">
                        <block type="math_number">
                            <field name="NUM">1</field>
                        </block>
                    </value>
                    <value name="TO">
                        <block type="math_number">
                            <field name="NUM">10</field>
                        </block>
                    </value>
                    <value name="BY">
                        <block type="math_number">
                            <field name="NUM">1</field>
                        </block>
                    </value>
                </block>
                <block type="controls_forEach"></block>
                <block type="controls_flow_statements"></block>
                <!--控制和逻辑合并-->
                <!-- </category>
            <category name="逻辑" colour="#AE8964"> -->
                <block type="controls_if"></block>
                <block type="logic_compare"></block>
                <block type="logic_operation"></block>
                <block type="logic_boolean"></block>
                <block type="logic_negate"></block>
                <block type="logic_null"></block>
                <block type="logic_ternary"></block>
            </category>
            <category name="数学" colour="#FEAE8A">
                <block type="math_number">
                    <field name="NUM">114514</field>
                </block>
                <block type="math_arithmetic"></block>
                <block type="math_single"></block>
                <block type="math_trig"></block>
                <block type="math_constant"></block>
                <block type="math_number_property"></block>
                <block type="math_round"></block>
                <block type="math_on_list"></block>
                <block type="math_modulo"></block>
                <block type="math_constrain">
                    <value name="LOW">
                        <block type="math_number">
                            <field name="NUM">114</field>
                        </block>
                    </value>
                    <value name="HIGH">
                        <block type="math_number">
                            <field name="NUM">514</field>
                        </block>
                    </value>
                </block>
                <block type="math_random_int">
                    <value name="FROM">
                        <block type="math_number">
                            <field name="NUM">191</field>
                        </block>
                    </value>
                    <value name="TO">
                        <block type="math_number">
                            <field name="NUM">9810</field>
                        </block>
                    </value>
                </block>
                <block type="math_random_float"></block>
                <block type="math_atan2"></block>
            </category>
            <category name="文本" colour="#1ab293">
                <block type="text"></block>
                <block type="text_length"></block>
                <block type="text_print"></block>
                <block type="text_join"></block>
                <block type="text_append">
                    <value name="TEXT">
                        <block type="text"></block>
                    </value>
                </block>
                <block type="text_length"></block>
                <block type="text_isEmpty"></block>
                <block type="text_indexOf"></block>
                <block type="text_getSubstring">
                    <value name="STRING">
                        <block type="variables_get">
                            <field name="VAR">{textVariable}</field>
                        </block>
                    </value>
                </block>
                <block type="text_charAt"></block>
                <block type="text_changeCase"></block>
                <block type="text_trim"></block>
                <block type="text_prompt_ext">
                    <value name="TEXT">
                        <shadow type="text">
                            <field name="TEXT">abc</field>
                        </shadow>
                    </value>
                </block>
                <block type="text_prompt_ext">
                    <value name="TEXT">
                        <block type="text"></block>
                    </value>
                </block>
            </category>
            <category name="颜色" colour="20">
                <block type="colour_picker"></block>
                <block type="colour_random"></block>
                <block type="colour_rgb">
                    <value name="RED">
                        <shadow type="math_number">
                            <field name="NUM">100</field>
                        </shadow>
                    </value>
                    <value name="GREEN">
                        <shadow type="math_number">
                            <field name="NUM">50</field>
                        </shadow>
                    </value>
                    <value name="BLUE">
                        <shadow type="math_number">
                            <field name="NUM">0</field>
                        </shadow>
                    </value>
                </block>
                <block type="colour_blend">
                    <value name="COLOUR1">
                        <shadow type="colour_picker">
                            <field name="COLOUR">#ff0000</field>
                        </shadow>
                    </value>
                    <value name="COLOUR2">
                        <shadow type="colour_picker">
                            <field name="COLOUR">#3333ff</field>
                        </shadow>
                    </value>
                    <value name="RATIO">
                        <shadow type="math_number">
                            <field name="NUM">0.5</field>
                        </shadow>
                    </value>
                </block>
            </category>
            <sep></sep>
            <category name="变量" colour="#FFBB55" custom="VARIABLE"></category>
            <category name="列表" colour="#F9CC37">
                <block type="lists_create_with">
                    <mutation items="0"></mutation>
                </block>
                <block type="lists_create_with"></block>
                <block type="lists_repeat">
                    <value name="NUM">
                        <shadow type="math_number">
                            <field name="NUM">5</field>
                        </shadow>
                    </value>
                </block>
                <block type="lists_length"></block>
                <block type="lists_isEmpty"></block>
                <block type="lists_indexOf">
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR">{listVariable}</field>
                        </block>
                    </value>
                </block>
                <block type="lists_getIndex">
                    <value name="VALUE">
                        <block type="variables_get">
                            <field name="VAR">{listVariable}</field>
                        </block>
                    </value>
                </block>
                <block type="lists_setIndex">
                    <value name="LIST">
                        <block type="variables_get">
                            <field name="VAR">{listVariable}</field>
                        </block>
                    </value>
                </block>
                <block type="lists_getSublist">
                    <value name="LIST">
                        <block type="variables_get">
                            <field name="VAR">{listVariable}</field>
                        </block>
                    </value>
                </block>
                <block type="lists_split">
                    <value name="DELIM">
                        <shadow type="text">
                            <field name="TEXT">,</field>
                        </shadow>
                    </value>
                </block>
                <block type="lists_sort"></block>
            </category>
            <category name="函数" colour="#F88767" custom="PROCEDURE"></category>
            <!-- </category> -->
            <sep></sep>
            <category name="不可见控件" colour="114">
                <block type="ivw_invisiblewidget">
                    <field name="type">MY_WIDGET</field>
                    <field name="icon">链接</field>
                    <field name="title">我的控件</field>
                    <field name="isGlobalWidget">TRUE</field>
                    <value name="properties">
                        <shadow type="lists_create_with">
                            <mutation items="0" />
                        </shadow>
                    </value>
                    <value name="methods">
                        <shadow type="lists_create_with">
                            <mutation items="0" />
                        </shadow>
                    </value>
                    <value name="event">
                        <shadow type="lists_create_with">
                            <mutation items="0" />
                        </shadow>
                    </value>
                    <value name="functionsList">
                        <shadow type="lists_create_with">
                            <mutation items="0" />
                        </shadow>
                    </value>
                </block>
            </category>
            <category name='CoCo' colour="114">
                <block type="coco_emit">
                    <field name="eventName">事件名称</field>
                    <value name="parameters">
                        <block type="lists_create_with">
                            <mutation items="0"></mutation>
                        </block>
                    </value>
                </block>
                <block type="coco_property">
                    <field name="key">属性名</field>
                    <field name="label">标签</field>
                    <field name="valueType">string</field>
                    <field name="default">默认值</field>
                </block>
                <block type="coco_method">
                    <field name="key">方法名</field>
                    <field name="label">标签</field>
                    <value name="params">
                        <block type="lists_create_with">
                            <mutation items="0"></mutation>
                        </block>
                    </value>
                </block>
                <block type="coco_method_return">
                    <field name="key">方法名</field>
                    <field name="label">标签</field>
                    <field name="valueType">string</field>
                    <value name="params">
                        <block type="lists_create_with">
                            <mutation items="0"></mutation>
                        </block>
                    </value>
                    <statement name="function_1">
                        <block type="coco_return"></block>
                    </statement>
                </block>
                <block type="coco_method_parameter">
                    <field name="key">参数名</field>
                    <field name="label">标签</field>
                    <field name="labelAfter">尾标签</field>
                    <field name="valueType">string</field>
                    <field name="default">默认值</field>
                </block>
                <block type="coco_event">
                    <field name="key">事件名</field>
                    <field name="label">标签</field>
                    <value name="params">
                        <block type="lists_create_with">
                            <mutation items="0"></mutation>
                        </block>
                    </value>
                </block>
                <block type="coco_event_parameter">
                    <field name="key">参数名</field>
                    <field name="label">标签</field>
                    <field name="valueType">string</field>
                </block>
                <block type="coco_return"></block>
            </category>
            <category name="JavaScript" colour="180">
                <label text="鸡肋积木"></label>
                <block type="js_usestrict"></block>
                <block type="js_bitwise"></block>
                <block type="js_comparisons"></block>
                <block type="js_time"></block>
                <block type="js_popup_alert"></block>
                <block type="js_popup_confirm"></block>
                <block type="js_popup_prompt"></block>
                <block type="js_json_parse"></block>
                <block type="js_json_stringify"></block>
                <block type="js_json_access"></block>
                <block type="js_window_screen"></block>
                <block type="js_window_avail_screen"></block>
                <block type="js_window_depth"></block>
                <block type="js_window_pixeldepth"></block>
                <block type="js_navigator_online"></block>
                <block type="js_navigator_language"></block>
                <block type="js_navigator_platform"></block>
                <block type="js_math_constant"></block>
                <block type="js_console_clean"></block>
                <block type="js_console_count"></block>
                <block type="js_console_error"></block>
                <block type="js_console_warn"></block>
                <block type="js_console_log"></block>
                <block type="js_console_time"></block>
                <block type="js_console_timeend"></block>
                <block type="js_base64"></block>
            </category>
            <category name="工具" colour="#9429FF">
                <label text="工具.积木夹子"></label>
                <label text="方便积木分段，折叠；顶部注释积木夹子标签"></label>
                <block type="tools_blocks_clip"></block>

                <label text="工具.仅运行"></label>
                <label text="用于运行有返回值的积木"></label>
                <block type="tools_only_run"></block>

                <label text="工具.注释"></label>
                <label text="用于插入单行注释"></label>
                <block type="tools_exegesis"></block>
            </category>
        </xml>
    </div>
    <div id="code" style="display: none;height: 95%;width: 100%;padding: 5px">
        <textarea id="codeArea" style="height: 100%;width: 100%;padding: 5px"></textarea>
    </div>
    <script>
        //定义主题
        var theme = widgetCraftTheme;
        //工作区
        var workspace = Blockly.inject('blocklyDiv',
            {
                toolbox: document.getElementById('toolbox'),
                grid:
                {
                    spacing: 13,
                    length: 13,
                    colour: '#E8E8E8',
                    snap: true,
                    trashcan: true
                },
                zoom:
                {
                    controls: true,
                    wheel: true,
                    startScale: 0.9,
                    maxScale: 3,
                    minScale: 0.3,
                    scaleSpeed: 1.2
                },
                theme: theme,
                renderer: 'zelos' //scratch风格，自定义的是custom_renderer
            });
        let getjscode = function () {
            var code = Blockly.JavaScript.workspaceToCode(workspace);
            alert(code);
        };
        let switch_table = function () {
            var code = document.getElementById("code")
            code.style.display = "none";
            var table = document.getElementById("table")
            table.style.display = "inline";
        }
        let switch_code = function () {
            var code = document.getElementById("code")
            code.style.display = "inline";
            var table = document.getElementById("table")
            table.style.display = "none";
            var codeArea = document.getElementById("codeArea")
            codeArea.innerHTML = Blockly.JavaScript.workspaceToCode(workspace);
        }
        window.onbeforeunload = function () {
            return "离开后，你的控件就没啦！";
        }
        let save = function () {
            let code_xml = Blockly.Xml.workspaceToDom(workspace);
            let code_data = Blockly.Xml.domToText(code_xml);
            let blob = new Blob([code_data], { type: "text/plain;charset=utf-8" });
            let url = URL.createObjectURL(blob);
            let downa = document.getElementById("downa");
            downa.href = url;
            downa.click();
            URL.revokeObjectURL(url);
        }
        let craft = function () {
            workspace.clear()
        }
        document.getElementById('read').addEventListener('change', function selectedFileChanged() {
            if (this.files.length !== 0) {
                workspace.clear()
                const reader = new FileReader();
                reader.onload = function fileReadCompleted() {
                    const xml = Blockly.Xml.textToDom(reader.result);
                    Blockly.Xml.domToWorkspace(xml, workspace);
                };
                reader.readAsText(this.files[0]);
            }
        });
    </script>
    <a href="" download="CocoWidget.cw" style="display: none;" id="downa"></a>
    <style>
        .js_button {
            padding: 10px;
        }

        .nav {
            height: 5%;
        }

        .nav-item {
            height: 5%;
        }

        .nav-link {
            height: 5%;
        }
    </style>
</body>

</html>